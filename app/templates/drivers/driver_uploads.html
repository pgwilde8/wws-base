<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paperwork Automation | Green Candle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .neon-glow { text-shadow: 0 0 8px rgba(59, 130, 246, 0.5); }
        .fuel-bar { transition: width 1.5s ease-in-out; }
        body { background-color: #020617; }
    </style>
</head>
<body class="text-slate-200 font-sans pb-24" style="--fuel-pct: {{ (((balance|default(0)) / 50) * 100)|round(0) }}">

    <header class="p-6 bg-slate-900 border-b border-slate-800 sticky top-0 z-50 shadow-2xl">
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-green-600 p-3 rounded-2xl shadow-lg shadow-green-500/20">
                    <i class="fas fa-file-invoice text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black tracking-tighter text-white">PAPERWORK</h1>
                    <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">BOL & Load Documents</p>
                    <p class="text-slate-400 text-sm">Upload proof of delivery to earn $CANDLE refill</p>
                </div>
            </div>
            <div class="w-full md:w-80 bg-black/40 border border-slate-800 p-4 rounded-2xl">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-widest">Automation Fuel</span>
                    <span class="text-xl font-black text-white neon-glow">{{ "%.1f"|format(balance) }} <span class="text-xs text-blue-500">$CANDLE</span></span>
                </div>
                <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden">
                    <div class="bg-blue-500 h-full fuel-bar" style="width: calc(var(--fuel-pct) * 1%)"></div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6">
        <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4">Won Loads – Upload Documents</h3>

        {% if won_loads %}
        <div class="space-y-4">
            {% for load in won_loads %}
            <div class="bg-slate-900 border border-slate-800 rounded-2xl p-5 shadow-xl">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <div class="text-green-400 text-xs font-bold uppercase">Load #{{ load.load_id }}</div>
                        <div class="text-white text-base font-bold">{{ load.origin }} → {{ load.destination }}</div>
                    </div>
                    <div class="text-right">
                        <span class="text-white font-mono font-bold">${{ "{:,.2f}".format(load.final_rate) }}</span>
                        {% if load.estimated_credits_candle and load.estimated_credits_candle > 0 %}
                        <div class="text-[10px] text-green-400">
                            <i class="fas fa-coins mr-0.5"></i> ~{{ "%.1f"|format(load.estimated_credits_candle) }} $CANDLE to earn
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div id="upload-result-{{ load.load_id }}" class="mb-4"></div>
                <div id="factoring-slot-{{ load.load_id }}" class="mb-4">
                    {% if load.factoring_status == 'SENT' %}
                    <div class="w-full bg-green-900/40 border-2 border-green-500/60 rounded-xl p-4 shadow-lg shadow-green-500/10">
                        <div class="flex items-center gap-3">
                            <div class="bg-green-500/30 p-2 rounded-full">
                                <i class="fas fa-paper-plane text-green-400 text-lg"></i>
                            </div>
                            <div>
                                <div class="text-green-400 font-black text-sm uppercase">Sent to Factoring</div>
                                <p class="text-slate-300 text-xs mt-1">Packet delivered. Est. funding: ${{ "{:,.2f}".format(load.final_rate) }}</p>
                            </div>
                        </div>
                    </div>
                    {% elif load.has_bol %}
                    <form hx-post="/drivers/loads/{{ load.load_id }}/send-to-factoring"
                          hx-target="#factoring-slot-{{ load.load_id }}"
                          hx-swap="innerHTML">
                        <button type="submit"
                                class="relative w-full bg-green-600 hover:bg-green-500 text-white font-black py-3 rounded-xl transition shadow-lg shadow-green-500/20 flex items-center justify-center gap-2">
                            <i class="fas fa-paper-plane"></i> SEND TO FACTORING
                            <span class="absolute top-2 right-3 bg-slate-800/90 text-blue-400 text-[9px] font-bold px-2 py-0.5 rounded" title="Cost: 0.3 $CANDLE">0.3 $C</span>
                        </button>
                    </form>
                    {% else %}
                    <button disabled
                            class="w-full bg-slate-800 text-slate-500 font-black py-3 rounded-xl cursor-not-allowed flex items-center justify-center gap-2">
                        <i class="fas fa-file-upload mr-2"></i> UPLOAD BOL TO FACTOR
                    </button>
                    {% endif %}
                </div>
                <form hx-post="/drivers/loads/{{ load.load_id }}/upload-document"
                      hx-target="#upload-result-{{ load.load_id }}"
                      hx-swap="innerHTML"
                      hx-encoding="multipart/form-data"
                      hx-indicator="#upload-spinner-{{ load.load_id }}"
                      class="flex flex-wrap gap-3 items-end">
                    <input type="hidden" name="doc_type" value="BOL" />
                    <label class="cursor-pointer inline-flex items-center gap-2 bg-green-700/80 hover:bg-green-600 text-white text-sm font-bold px-4 py-2.5 rounded-lg transition">
                        <i class="fas fa-file-upload"></i>
                        <span>Choose BOL (image or PDF)</span>
                        <input type="file" name="file" accept="image/*,.pdf" class="hidden" required />
                    </label>
                    <button type="submit" class="bg-slate-700 hover:bg-slate-600 text-slate-300 text-sm font-bold px-4 py-2.5 rounded-lg transition">
                        <i class="fas fa-paper-plane mr-1"></i> Upload
                    </button>
                </form>
                <div id="upload-spinner-{{ load.load_id }}" class="htmx-indicator text-slate-500 text-xs mt-2">
                    <i class="fas fa-spinner fa-spin mr-1"></i> Processing...
                </div>

                <div class="flex gap-2 mt-3">
                    <a href="/drivers/loads/{{ load.load_id }}/manage"
                       class="flex-1 bg-green-600 hover:bg-green-500 text-white text-xs font-bold py-2 rounded-lg text-center transition flex items-center justify-center gap-2">
                        <i class="fas fa-cog mr-1"></i> Manage Load
                    </a>
                    <a href="/drivers/terminal/{{ load.load_id }}"
                       class="flex-1 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-bold py-2 rounded-lg text-center transition flex items-center justify-center gap-2">
                        <i class="fas fa-terminal mr-1"></i> Terminal
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-slate-900 border border-slate-800 rounded-2xl p-12 text-center">
            <div class="bg-slate-800 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-600">
                <i class="fas fa-file-alt text-2xl"></i>
            </div>
            <h4 class="text-white font-bold">No Won Loads Yet</h4>
            <p class="text-slate-500 text-sm mt-2 max-w-sm mx-auto">
                When you win a load, it will appear here. Upload your BOL (Bill of Lading) to earn your $CANDLE refill (21% of the 2.5% dispatch fee).
            </p>
            <a href="/drivers/dashboard" class="mt-6 inline-block bg-white text-black font-bold text-xs px-6 py-3 rounded-full uppercase tracking-tighter hover:bg-blue-500 hover:text-white transition">
                Back to Dashboard
            </a>
        </div>
        {% endif %}
    </main>

    <nav class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900/80 backdrop-blur-xl border border-slate-800 p-2 rounded-2xl shadow-2xl z-50">
        <div class="flex items-center gap-1">
            <a href="/drivers/dashboard" class="text-slate-400 hover:text-white px-6 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a href="/drivers/scout-loads" class="text-slate-400 hover:text-white px-6 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2">
                <i class="fas fa-satellite-dish"></i> Scout Loads
            </a>
            <a href="/drivers/load-board" class="text-slate-400 hover:text-white px-6 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2">
                <i class="fas fa-radar"></i> Load Board
            </a>
            <a href="/drivers/fleet" class="text-slate-400 hover:text-white px-6 py-2 rounded-xl text-xs font-bold transition">
                <i class="fas fa-truck-ramp-box"></i> Fleet
            </a>
            <a href="/drivers/uploads" class="bg-green-600 text-white px-6 py-2 rounded-xl text-xs font-bold flex items-center gap-2">
                <i class="fas fa-file-upload"></i> Paperwork
            </a>
            <button type="button" onclick="document.getElementById('help-drawer').classList.remove('translate-x-full')" class="text-slate-400 hover:text-white px-6 py-2 rounded-xl text-xs font-bold transition flex items-center gap-2">
                <i class="fas fa-question-circle"></i> Help
            </button>
        </div>
    </nav>

    {% include "drivers/partials/help_drawer.html" %}

    <script>
        document.body.addEventListener('bolUploaded', function() {
            window.location.reload();
        });
    </script>
</body>
</html>
