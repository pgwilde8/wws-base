<div class="space-y-6" id="onboarding-container">
    <div class="p-6 bg-slate-900/50 border border-slate-800 rounded-2xl">
        <h2 class="text-lg font-bold text-white mb-2">Step 3: Account Setup & Funding</h2>
        <p class="text-slate-400 text-sm mb-3">Select the number of trucks in your fleet. Setup is $25 per truck and includes $CANDLE credits for AI dispatch automation.</p>
        <div class="bg-blue-900/30 border border-blue-700/50 rounded-lg p-4 mt-4">
            <p class="text-xs text-blue-200 font-semibold mb-2">ðŸ“‹ Next Step After Payment:</p>
            <p class="text-xs text-blue-100">After payment, you will submit a quick form to our factoring partner <strong>Century Finance</strong> for same-day funding approval. Alma will personally review your application (usually 1-2 business days).</p>
            <p class="text-xs text-blue-200 mt-2"><strong>If approved:</strong> Your full dashboard unlocks automatically.</p>
            <p class="text-xs text-blue-200"><strong>If declined:</strong> Full refund of your $25 setup fee (processed within 3-5 business days).</p>
        </div>
    </div>
    <div class="bg-slate-900 border-2 border-dashed border-slate-700 rounded-2xl p-6">
        <div class="flex items-center justify-center gap-2 mb-6">
            <span class="bg-green-500 text-black text-[10px] font-black w-6 h-6 rounded-full flex items-center justify-center">âœ“</span>
            <span class="bg-green-500 text-black text-[10px] font-black w-6 h-6 rounded-full flex items-center justify-center">âœ“</span>
            <span class="bg-blue-500 text-white text-[10px] font-black w-6 h-6 rounded-full flex items-center justify-center ring-4 ring-blue-500/20">3</span>
        </div>

        <h3 class="text-green-400 font-bold mb-4 text-center">How many trucks?</h3>

        <form id="payment-form" class="space-y-4 max-w-xs mx-auto">
            <div>
                <label for="truck_count" class="block text-[10px] text-slate-400 uppercase font-bold mb-1.5">
                    <i class="fas fa-truck mr-1 text-slate-500"></i>Number of trucks
                </label>
                <select name="truck_count" id="truck_count"
                        class="w-full bg-slate-950 border-2 border-slate-600 p-3 rounded-lg text-center font-mono text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 appearance-none cursor-pointer">
                    <option value="1">1 truck â€” $25</option>
                    <option value="2">2 trucks â€” $50</option>
                    <option value="3">3 trucks â€” $75</option>
                    <option value="4">4 trucks â€” $100</option>
                    <option value="5">5 trucks â€” $125</option>
                </select>
            </div>

            <div class="p-4 bg-slate-800/50 rounded-xl border border-slate-700 text-center">
                <p class="text-[10px] text-slate-500 uppercase font-bold mb-1">Total</p>
                <p class="text-2xl font-black text-green-400"><span id="total-display">$25</span></p>
                <p class="text-[9px] text-slate-500 mt-1">$25 Ã— <span id="qty-display">1</span> truck<span id="qty-plural">s</span></p>
            </div>

            {% if error %}
            <div id="payment-error" class="p-3 bg-red-900/40 border border-red-500/50 rounded-lg text-red-300 text-xs text-center">
                {{ error }}
            </div>
            {% endif %}

            <div class="mt-4 p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                <label class="flex items-start gap-2 cursor-pointer text-xs text-slate-300">
                    <input type="checkbox" id="agree-refund" class="mt-0.5 rounded border-slate-600 bg-slate-800 text-green-500 focus:ring-green-500" required />
                    <span>I understand the $25 setup fee is refundable if Century Finance declines my funding application. By proceeding, I agree to submit my information to Century Finance for approval.</span>
                </label>
            </div>

            <div class="flex justify-center gap-3 mt-6">
                <button type="button" id="btn-proceed"
                        class="bg-green-600 hover:bg-green-500 text-white text-sm font-bold py-3 px-8 rounded-full transition active:scale-95 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-credit-card"></i>
                    <span>Proceed to Payment</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    var select = document.getElementById('truck_count');
    var totalDisplay = document.getElementById('total-display');
    var qtyDisplay = document.getElementById('qty-display');
    var qtyPlural = document.getElementById('qty-plural');
    var btn = document.getElementById('btn-proceed');

    function updateDisplay() {
        var qty = parseInt(select.value, 10) || 1;
        var total = qty * 25;
        totalDisplay.textContent = '$' + total;
        qtyDisplay.textContent = qty;
        qtyPlural.textContent = qty === 1 ? '' : 's';
    }
    select.addEventListener('change', updateDisplay);
    updateDisplay();

    var agreeCheckbox = document.getElementById('agree-refund');
    function updateButtonState() {
        if (btn && agreeCheckbox) {
            btn.disabled = !agreeCheckbox.checked;
        }
    }
    if (agreeCheckbox) {
        agreeCheckbox.addEventListener('change', updateButtonState);
        updateButtonState();
    }

    if (btn) {
        btn.addEventListener('click', function() {
            if (!agreeCheckbox || !agreeCheckbox.checked) {
                alert('Please confirm you understand the refund policy before proceeding.');
                return;
            }
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Redirecting...';
            var truckCount = parseInt(select.value, 10) || 1;
            fetch('/century/onboarding/create-setup-checkout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' },
                body: JSON.stringify({ truck_count: truckCount }),
                credentials: 'same-origin'
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-credit-card"></i> <span>Proceed to Payment</span>';
                    alert(data.error || 'Unable to start checkout. Please try again.');
                }
            })
            .catch(function() {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-credit-card"></i> <span>Proceed to Payment</span>';
                alert('Checkout failed. Please try again.');
            });
        });
    }
})();
</script>
