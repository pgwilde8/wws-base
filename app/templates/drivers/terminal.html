<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Negotiation Terminal | Load #{{ load_id }} | Green Candle</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .terminal-font { font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; }
        .scanline { background: linear-gradient(transparent 50%, rgba(0,0,0,.1) 50%); background-size: 100% 4px; }
    </style>
</head>
<body class="bg-black text-green-400 terminal-font min-h-screen flex flex-col">

    <!-- Header -->
    <div class="border-b border-green-900/50 bg-slate-950 px-4 py-3 flex justify-between items-center">
        <a href="/clients/dashboard" class="text-slate-500 hover:text-green-400 text-sm">
            <i class="fas fa-arrow-left mr-2"></i>Back to Command
        </a>
        <div class="text-xs font-mono text-slate-500">
            LOAD #{{ load_id }} <span class="text-green-600">|</span> NEGOTIATION TERMINAL
        </div>
    </div>

    <!-- Market Bar -->
    <div class="p-4 pb-0">
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="bg-slate-900 border border-slate-800 p-2 rounded flex justify-between items-center">
                <span class="text-[9px] text-slate-500 uppercase">Market Avg</span>
                <span class="text-xs font-bold text-white">${{ "{:,.0f}".format(market_price) }}</span>
            </div>
            <div class="bg-slate-900 border border-slate-800 p-2 rounded flex justify-between items-center">
                <span class="text-[9px] text-slate-500 uppercase">Lane Rate</span>
                <span class="text-xs font-bold text-blue-400">${{ "%.2f"|format(market_rpm) }}/mi</span>
            </div>
        </div>

        <div class="bg-blue-900/20 border border-blue-500/30 p-3 rounded-lg mb-4">
            <div class="text-[10px] text-blue-400 font-bold uppercase mb-1">Market Sentiment</div>
            <p class="text-[11px] text-slate-300">
                {% if latest_offer and latest_offer < market_price %}
                Broker is low-balling. This lane is currently paying <span class="text-white font-bold">${{ "{:,.0f}".format(market_price) }}</span>.
                Your break-even is <span class="text-green-400">${{ "{:,.0f}".format(settings.floor_price) }}</span>.
                I recommend holding at <span class="text-white font-bold">${{ "{:,.0f}".format(market_price - 50) }}</span> for a quick win.
                {% elif latest_offer and latest_offer >= market_price %}
                Broker offer <span class="text-white font-bold">${{ "{:,.0f}".format(latest_offer) }}</span> is at or above market (<span class="text-blue-400">${{ "{:,.0f}".format(market_price) }}</span>). Strong position to accept.
                {% else %}
                This lane pays ~<span class="text-white font-bold">${{ "{:,.0f}".format(market_price) }}</span> ({{ "%.2f"|format(market_rpm) }}/mi).
                Your floor is <span class="text-green-400">${{ "{:,.0f}".format(settings.floor_price) }}</span>. Aim for <span class="text-white font-bold">${{ "{:,.0f}".format(market_price - 50) }}</span> or better when broker confirms.
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Broker Message History -->
    <div class="flex-1 overflow-y-auto p-4 space-y-4">
        <h3 class="text-slate-500 text-[10px] uppercase font-bold tracking-wider">Broker Replies</h3>
        {% if messages %}
        {% for m in messages %}
        <div class="bg-slate-900/80 border border-slate-700 rounded-lg p-3 {{ 'border-l-4 border-l-green-500' if not m.is_read else '' }}">
            <div class="flex justify-between items-start text-[10px] text-slate-500 mb-1">
                <span class="truncate">{{ m.sender_email }}</span>
                {% if m.received_at %}
                <span>{{ m.received_at.strftime('%m/%d %H:%M') if m.received_at else '' }}</span>
                {% endif %}
            </div>
            {% if m.subject %}
            <div class="text-slate-400 text-xs font-bold mb-1">{{ m.subject }}</div>
            {% endif %}
            <div class="text-slate-300 text-sm whitespace-pre-wrap">{{ m.body_text }}</div>
        </div>
        {% endfor %}
        {% else %}
        <div class="text-slate-600 text-sm text-center py-8 border border-dashed border-slate-800 rounded-lg">
            <i class="fas fa-inbox text-2xl mb-2 block"></i>
            No broker replies yet for this load.
        </div>
        {% endif %}
    </div>

    <!-- AI Recommendation + Auto-Pilot -->
    <div class="border-t border-green-900/50 bg-slate-950/95 p-4">
        <!-- Auto-Pilot (Autonomous Dispatch) -->
        <div class="bg-slate-900 border {{ 'border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.3)]' if settings.is_autopilot else 'border-slate-800' }} rounded-xl p-4 mb-4 transition-all duration-500">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="{{ 'text-blue-400 animate-pulse' if settings.is_autopilot else 'text-slate-600' }}">
                        <i class="fas fa-robot text-xl"></i>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold {{ 'text-blue-400' if settings.is_autopilot else 'text-slate-400' }}">
                            AUTONOMOUS DISPATCH
                        </h4>
                        <p class="text-[9px] text-slate-500 uppercase">Cost: {{ autopilot_cost }} $CANDLE (Charged only on success)</p>
                        <p class="text-[9px] text-slate-500">Floor: ${{ "%.0f"|format(settings.floor_price) }} | Target: ${{ "%.0f"|format(settings.target_price) }}</p>
                    </div>
                </div>

                {% if can_use_autopilot %}
                <form hx-post="/clients/load/{{ load_id }}/toggle-autopilot"
                      hx-swap="none"
                      hx-trigger="change from:input"
                      class="inline">
                    <input type="hidden" name="floor_price" value="{{ settings.floor_price or 0 }}">
                    <input type="hidden" name="target_price" value="{{ settings.target_price or 0 }}">
                    <input type="hidden" name="miles" value="{{ load_miles or 500 }}">
                    <label class="relative inline-flex h-5 w-10 cursor-pointer items-center rounded-full {{ 'bg-blue-600' if settings.is_autopilot else 'bg-slate-700' }} transition-colors">
                        <input type="checkbox"
                               name="enable"
                               value="1"
                               class="sr-only peer"
                               {% if settings.is_autopilot %}checked{% endif %}>
                        <span class="inline-block h-3 w-3 transform rounded-full bg-white transition {{ 'translate-x-5' if settings.is_autopilot else 'translate-x-1' }}"></span>
                    </label>
                </form>
                {% else %}
                <span class="text-[9px] text-red-500 font-bold">LOW BALANCE</span>
                <span class="text-[9px] text-slate-500">({{ "%.1f"|format(driver_balance) }}/{{ autopilot_cost }})</span>
                {% endif %}
            </div>

            {% if settings.is_autopilot %}
            <div class="mt-3 pt-3 border-t border-slate-800/50">
                <div class="text-[10px] text-blue-300 italic">
                    <i class="fas fa-info-circle mr-1"></i> Robot is monitoring. Floor based on ${{ "%.2f"|format(fuel_avg) }}/gal fuel cost + $CANDLE fees.
                </div>
            </div>
            {% endif %}
        </div>

        <div class="bg-green-950/40 border border-green-800/50 rounded-lg p-3 mb-4">
            <div class="text-[10px] text-green-500 uppercase font-bold mb-1">AI Recommendation</div>
            <div class="text-slate-300 text-sm">
                {% if latest_offer %}
                    Broker offer detected at <span class="text-white font-bold">${{ "%.0f"|format(latest_offer) }}</span>.
                    {% if gap and gap > 0 %}
                        This is <span class="text-amber-400">-${{ gap }}</span> below suggested target.
                        Suggest countering at <span class="text-green-400">${{ target_price }}</span>.
                    {% else %}
                        Consider accepting or countering above this rate.
                    {% endif %}
                {% else %}
                    {% if messages %}
                        Waiting for broker to confirm price. Suggest asking for their "Best out the door" rate.
                    {% else %}
                        No broker replies yet. Messages will appear here once they respond.
                    {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons (HTMX) -->
        <div class="grid grid-cols-3 gap-2 mb-2">
            <button hx-post="/clients/negotiate/{{ load_id }}/accept"
                    hx-swap="none"
                    hx-confirm="Accept this offer?"
                    class="bg-green-600 hover:bg-green-500 text-black font-bold py-3 rounded text-xs transition active:scale-95">
                <i class="fas fa-check mr-1"></i>Accept
            </button>
            <button hx-post="/clients/negotiate/{{ load_id }}/counter"
                    hx-vals='{"increment": 100}'
                    hx-swap="none"
                    class="bg-amber-600 hover:bg-amber-500 text-black font-bold py-3 rounded text-xs transition active:scale-95">
                <i class="fas fa-plus mr-1"></i>Counter +$100
            </button>
            <button hx-post="/clients/negotiate/{{ load_id }}/ignore"
                    hx-swap="none"
                    class="bg-slate-700 hover:bg-slate-600 text-slate-300 font-bold py-3 rounded text-xs transition active:scale-95">
                <i class="fas fa-times mr-1"></i>Ignore
            </button>
        </div>
        <button hx-post="/clients/negotiate/{{ load_id }}/counter-to-market"
                hx-swap="none"
                class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded text-xs transition active:scale-95 flex items-center justify-center gap-2">
            <i class="fas fa-chart-line"></i> Counter to Market (${{ "{:,.0f}".format(market_price) }})
        </button>
    </div>

    <script>
        document.body.addEventListener('negotiationUpdated', function() {
            window.location.reload();
        });
    </script>
</body>
</html>
