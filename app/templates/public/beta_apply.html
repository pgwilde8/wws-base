{% extends "layout/base.html" %}
{% block title %}Apply for Beta — Green Candle Dispatch{% endblock %}
{% block content %}
<section class="max-w-2xl mx-auto px-4 py-12">
  <h1 class="text-2xl font-bold text-white mb-6">Apply for Beta</h1>
  <p class="text-slate-400 text-sm mb-6">
    We’ll approve you and send login credentials within 24 hours. Setup fee waived.
  </p>

  <form id="beta-apply-form" class="space-y-4">
    <div>
      <label class="block text-sm font-medium text-slate-300 mb-1">Full name *</label>
      <input type="text" name="full_name" required minlength="2" maxlength="200"
             class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-green-500/50 focus:border-green-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-slate-300 mb-1">Email *</label>
      <input type="email" name="email" required
             class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-green-500/50 focus:border-green-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-slate-300 mb-1">Phone *</label>
      <input type="tel" name="phone" required minlength="7" maxlength="40"
             class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-green-500/50 focus:border-green-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-slate-300 mb-1">MC number *</label>
      <input type="text" name="mc_number" required minlength="2" maxlength="50"
             class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-green-500/50 focus:border-green-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-slate-300 mb-1">Carrier name</label>
      <input type="text" name="carrier_name" maxlength="255"
             class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-green-500/50 focus:border-green-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-slate-300 mb-1">Truck type</label>
      <input type="text" name="truck_type" maxlength="100"
             class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-green-500/50 focus:border-green-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-slate-300 mb-1">Preferred lanes</label>
      <input type="text" name="preferred_lanes" maxlength="400"
             class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-green-500/50 focus:border-green-500">
    </div>
    <div>
      <label class="block text-sm font-medium text-slate-300 mb-1">Factoring company (if any)</label>
      <input type="text" name="factoring_company" maxlength="200"
             class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-green-500/50 focus:border-green-500">
    </div>

    <div class="flex items-start gap-3 pt-2">
      <input type="checkbox" name="agree_weekly_invoice" id="agree_weekly_invoice" value="1"
             class="mt-1 h-4 w-4 rounded border-slate-600 bg-slate-900 text-green-500 focus:ring-green-500/50">
      <label for="agree_weekly_invoice" class="text-sm text-slate-300">
        I agree to <strong>weekly invoicing</strong> for the 2.5% dispatch fee after loads are completed (for drivers who don’t use factoring).
      </label>
    </div>

    <div id="form-error" class="text-red-400 text-sm hidden"></div>
    <div id="form-success" class="text-green-400 text-sm hidden"></div>

    <button type="submit" id="submit-btn"
            class="w-full bg-green-500 hover:bg-green-400 text-slate-900 font-bold py-3 rounded-xl transition disabled:opacity-50">
      Submit application
    </button>
  </form>
</section>

<script>
(function() {
  const form = document.getElementById('beta-apply-form');
  const submitBtn = document.getElementById('submit-btn');
  const formError = document.getElementById('form-error');
  const formSuccess = document.getElementById('form-success');

  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    formError.classList.add('hidden');
    formSuccess.classList.add('hidden');
    submitBtn.disabled = true;

    const payload = {
      full_name: form.full_name.value.trim(),
      email: form.email.value.trim().toLowerCase(),
      phone: form.phone.value.trim(),
      mc_number: form.mc_number.value.trim(),
      carrier_name: form.carrier_name.value.trim() || null,
      truck_type: form.truck_type.value.trim() || null,
      preferred_lanes: form.preferred_lanes.value.trim() || null,
      factoring_company: form.factoring_company.value.trim() || null,
      agree_weekly_invoice: form.agree_weekly_invoice.checked
    };

    try {
      const res = await fetch('/beta/apply', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(() => ({}));
      if (res.ok) {
        formSuccess.textContent = 'Application submitted. You\'ll receive login credentials within 24 hours.';
        formSuccess.classList.remove('hidden');
        form.reset();
      } else {
        formError.textContent = data.detail || (Array.isArray(data.detail) ? data.detail.map(d => d.msg).join(' ') : 'Submission failed.');
        formError.classList.remove('hidden');
      }
    } catch (err) {
      formError.textContent = 'Network error. Please try again.';
      formError.classList.remove('hidden');
    }
    submitBtn.disabled = false;
  });
})();
</script>
{% endblock %}
