{% extends "layout/base.html" %}

{% block content %}
<section class="max-w-4xl mx-auto px-4 py-16 space-y-8">
    <header class="text-center space-y-4">
        <p class="text-sm uppercase tracking-[0.3em] text-green-400 font-bold">Test Upload</p>
        <h1 class="text-4xl sm:text-5xl font-black text-white">BOL Upload to Spaces</h1>
        <p class="text-lg text-slate-400 max-w-2xl mx-auto leading-relaxed">
            Test uploading Bill of Lading files to DigitalOcean Spaces. Images are auto-converted to PDF.
            <span class="block mt-2 text-xs text-amber-400">
                ⚠️ This is a test page. In production, this will be behind driver authentication.
            </span>
        </p>
    </header>

    <!-- Upload Form -->
    <div class="bg-gradient-to-br from-slate-900 to-slate-950 border-2 border-green-500/50 rounded-3xl p-8 shadow-xl shadow-green-900/10">
        <form id="bol-upload-form"
              hx-post="/test/upload-bol"
              hx-target="#upload-result"
              hx-swap="innerHTML"
              hx-encoding="multipart/form-data"
              hx-indicator="#upload-spinner"
              class="space-y-6">
            
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs text-slate-400 mb-2 font-bold uppercase" for="mc_number">
                        MC Number <span class="text-red-400">*</span>
                    </label>
                    <input id="mc_number" 
                           name="mc_number" 
                           type="text" 
                           required 
                           placeholder="123456" 
                           value="TEST123"
                           class="w-full rounded-lg bg-slate-800 border border-slate-700 text-white px-4 py-3 text-sm focus:border-green-500 focus:outline-none" />
                </div>
                <div>
                    <label class="block text-xs text-slate-400 mb-2 font-bold uppercase" for="load_id">
                        Load ID <span class="text-red-400">*</span>
                    </label>
                    <input id="load_id" 
                           name="load_id" 
                           type="text" 
                           required 
                           placeholder="LOAD-12345" 
                           value="TEST-LOAD-001"
                           class="w-full rounded-lg bg-slate-800 border border-slate-700 text-white px-4 py-3 text-sm focus:border-green-500 focus:outline-none" />
                </div>
            </div>

            <div>
                <label class="block text-xs text-slate-400 mb-2 font-bold uppercase" for="file">
                    BOL File (Image or PDF) <span class="text-red-400">*</span>
                </label>
                <label class="cursor-pointer flex items-center gap-3 bg-green-700/80 hover:bg-green-600 text-white font-bold px-6 py-4 rounded-lg transition border-2 border-green-600/50 hover:border-green-500">
                    <i class="fas fa-file-upload text-xl"></i>
                    <span class="flex-1">Choose BOL file (JPG, PNG, PDF)</span>
                    <input type="file" 
                           id="file" 
                           name="file" 
                           accept="image/*,.pdf" 
                           class="hidden" 
                           required />
                </label>
                <p class="text-slate-500 text-xs mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Images will be automatically converted to PDF for professionalism.
                </p>
            </div>

            <button type="submit" 
                    class="w-full bg-green-500 hover:bg-green-400 text-slate-900 font-bold py-4 px-8 rounded-xl transition shadow-lg shadow-green-900/20 hover:-translate-y-0.5 flex items-center justify-center gap-2">
                <i class="fas fa-cloud-upload-alt"></i>
                Upload to Spaces
            </button>

            <div id="upload-spinner" class="htmx-indicator text-center text-slate-500">
                <i class="fas fa-spinner fa-spin text-2xl mr-2"></i>
                <p class="text-sm mt-2">Uploading to DigitalOcean Spaces...</p>
            </div>
        </form>

        <!-- Upload Result -->
        <div id="upload-result" class="mt-6"></div>
    </div>

    <!-- Info Section -->
    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-6 space-y-4">
        <h3 class="text-xl font-bold text-white flex items-center gap-2">
            <i class="fas fa-info-circle text-green-400"></i>
            How It Works
        </h3>
        <div class="space-y-3 text-slate-400 text-sm">
            <div class="flex items-start gap-3">
                <span class="text-green-400 font-bold">1.</span>
                <span>File is uploaded to <code class="bg-slate-800 px-2 py-1 rounded text-green-400">greencandle</code> bucket (private)</span>
            </div>
            <div class="flex items-start gap-3">
                <span class="text-green-400 font-bold">2.</span>
                <span>Images are converted to PDF automatically</span>
            </div>
            <div class="flex items-start gap-3">
                <span class="text-green-400 font-bold">3.</span>
                <span>Bucket + key are stored (not public URL)</span>
            </div>
            <div class="flex items-start gap-3">
                <span class="text-green-400 font-bold">4.</span>
                <span>Presigned URL is generated for viewing (expires in 1 hour)</span>
            </div>
            <div class="flex items-start gap-3">
                <span class="text-green-400 font-bold">5.</span>
                <span>Ready for OCR processing and factoring packet generation</span>
            </div>
        </div>
    </div>

    <!-- Test Spaces Retrieval -->
    <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-6">
        <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
            <i class="fas fa-flask text-green-400"></i>
            Test Spaces Retrieval
        </h3>
        <p class="text-slate-400 text-sm mb-4">
            Test retrieving a file from Spaces using <code class="bg-slate-800 px-2 py-1 rounded text-green-400">s3.get_object()</code>:
        </p>
        <div class="flex gap-2">
            <input type="text" 
                   id="test-bucket" 
                   value="greencandle" 
                   placeholder="Bucket"
                   class="flex-1 rounded-lg bg-slate-800 border border-slate-700 text-white px-4 py-2 text-sm focus:border-green-500 focus:outline-none" />
            <input type="text" 
                   id="test-key" 
                   value="dispatch/raw/bol/bol-1.pdf" 
                   placeholder="Key (e.g. dispatch/raw/bol/bol-1.pdf)"
                   class="flex-1 rounded-lg bg-slate-800 border border-slate-700 text-white px-4 py-2 text-sm focus:border-green-500 focus:outline-none" />
            <button onclick="testRetrieve()" 
                    class="bg-blue-600 hover:bg-blue-500 text-white font-bold px-6 py-2 rounded-lg transition">
                Test
            </button>
        </div>
        <div id="retrieve-result" class="mt-4"></div>
    </div>
</section>

<script>
function testRetrieve() {
    const bucket = document.getElementById('test-bucket').value;
    const key = document.getElementById('test-key').value;
    const resultDiv = document.getElementById('retrieve-result');
    
    resultDiv.innerHTML = '<div class="text-slate-500"><i class="fas fa-spinner fa-spin mr-2"></i>Testing...</div>';
    
    fetch(`/api/health/spaces-retrieve?bucket=${encodeURIComponent(bucket)}&key=${encodeURIComponent(key)}`)
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                resultDiv.innerHTML = `
                    <div class="bg-green-900/30 border border-green-500/50 rounded-lg p-4">
                        <div class="flex items-center gap-2 text-green-400 mb-2">
                            <i class="fas fa-check-circle"></i>
                            <span class="font-bold">Retrieval Successful!</span>
                        </div>
                        <div class="text-sm text-slate-300 space-y-1">
                            <div><strong>Bucket:</strong> <code class="bg-slate-800 px-2 py-1 rounded">${data.bucket}</code></div>
                            <div><strong>Key:</strong> <code class="bg-slate-800 px-2 py-1 rounded">${data.key}</code></div>
                            <div><strong>Size:</strong> ${data.size_bytes.toLocaleString()} bytes</div>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<div class="bg-red-900/30 border border-red-500/50 rounded-lg p-4 text-red-400">Error: ${data.detail || 'Unknown error'}</div>`;
            }
        })
        .catch(err => {
            resultDiv.innerHTML = `<div class="bg-red-900/30 border border-red-500/50 rounded-lg p-4 text-red-400">Error: ${err.message}</div>`;
        });
}
</script>
{% endblock %}
