{% extends "layout/admin_base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white">Century Finance Approvals</h1>
        <a href="/admin/dashboard" class="text-slate-400 hover:text-white">← Back to Dashboard</a>
    </div>

    {% if referrals|length == 0 %}
    <div class="bg-slate-900 border border-slate-800 rounded-xl p-8 text-center">
        <p class="text-slate-400">No pending referrals.</p>
    </div>
    {% else %}
    <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
        <table class="w-full">
            <thead class="bg-slate-800 border-b border-slate-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-300 uppercase">Driver</th>
                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-300 uppercase">MC #</th>
                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-300 uppercase">Trucks</th>
                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-300 uppercase">Submitted</th>
                    <th class="px-6 py-3 text-left text-xs font-bold text-slate-300 uppercase">Status</th>
                    <th class="px-6 py-3 text-right text-xs font-bold text-slate-300 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-800">
                {% for ref in referrals %}
                <tr class="hover:bg-slate-800/50">
                    <td class="px-6 py-4">
                        <div class="text-white font-semibold">{{ ref.full_name }}</div>
                        <div class="text-xs text-slate-400">{{ ref.email }}</div>
                        <div class="text-xs text-slate-500">{{ ref.cell_phone }}</div>
                    </td>
                    <td class="px-6 py-4 text-slate-300 font-mono">{{ ref.driver_mc_number }}</td>
                    <td class="px-6 py-4 text-slate-300">{{ ref.number_of_trucks }}</td>
                    <td class="px-6 py-4 text-slate-400 text-sm">{{ ref.submitted_at.strftime('%m/%d/%Y %I:%M %p') if ref.submitted_at else 'N/A' }}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs font-bold rounded {% if ref.status == 'PENDING' %}bg-amber-900/40 text-amber-300{% elif ref.status == 'CONTACTED' %}bg-blue-900/40 text-blue-300{% else %}bg-slate-700 text-slate-300{% endif %}">
                            {{ ref.status }}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <form method="POST" action="/admin/century-approvals/{{ ref.id }}/approve" class="inline mr-2">
                            <button type="submit" class="bg-green-600 hover:bg-green-500 text-white text-xs font-bold px-3 py-1 rounded">Approve</button>
                        </form>
                        <form method="POST" action="/admin/century-approvals/{{ ref.id }}/decline" class="inline">
                            <button type="submit" class="bg-red-600 hover:bg-red-500 text-white text-xs font-bold px-3 py-1 rounded" onclick="return confirm('Decline this referral and refund $25?')">Decline</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div class="mt-10">
        <h3 class="text-xl font-bold text-white mb-4">Recently Declined Referrals</h3>
        {% if request.query_params.get('error') == 'already_declined' %}
        <div class="mb-4 p-3 bg-amber-900/40 border border-amber-500/50 rounded-lg text-amber-200 text-sm">That referral was already declined.</div>
        {% endif %}
        {% if declined_referrals %}
        <div class="bg-slate-900 border border-slate-800 rounded-xl overflow-hidden">
            <table class="w-full">
                <thead class="bg-slate-800 border-b border-slate-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-bold text-slate-300 uppercase">ID</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-slate-300 uppercase">Name / MC#</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-slate-300 uppercase">Declined At</th>
                        <th class="px-6 py-3 text-left text-xs font-bold text-slate-300 uppercase">Refund Status</th>
                        <th class="px-6 py-3 text-right text-xs font-bold text-slate-300 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-800">
                    {% for ref in declined_referrals %}
                    <tr class="hover:bg-slate-800/50">
                        <td class="px-6 py-4 text-slate-400 font-mono">{{ ref.id }}</td>
                        <td class="px-6 py-4">
                            <span class="text-white">{{ ref.full_name }}</span>
                            <span class="text-slate-500 font-mono text-xs"> ({{ ref.driver_mc_number }})</span>
                        </td>
                        <td class="px-6 py-4 text-slate-400 text-sm">{{ ref.refunded_at.strftime('%Y-%m-%d %H:%M') if ref.refunded_at else 'N/A' }}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-bold rounded {% if ref.refund_status == 'SUCCEEDED' %}bg-green-900/40 text-green-300{% elif ref.refund_status == 'FAILED' %}bg-red-900/40 text-red-300{% else %}bg-slate-700 text-slate-300{% endif %}">
                                {{ ref.refund_status or 'Not Started' }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            {% if ref.refund_status == 'FAILED' %}
                            <form method="POST" action="/admin/century-approvals/{{ ref.id }}/retry-refund" class="inline">
                                <button type="submit" class="bg-amber-600 hover:bg-amber-500 text-white text-xs font-bold px-3 py-1 rounded" onclick="return confirm('Retry Stripe refund for this referral?')">Retry Refund</button>
                            </form>
                            {% else %}
                            <span class="text-slate-500 text-xs">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-slate-500">No recent declines.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
